
<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>入口｜角色登入與系統導覽</title>
  <link rel="stylesheet" href="style.css"/>
</head>
<body>
  <div class="card">
    <div class="header">
      <div class="h1">益福入口 Portal</div>
      <div id="statusBadge" class="badge">未登入</div>
    </div>
    <div class="body">
      <div class="panel">
        <h2>登入(密碼幫你們紀錄完了直接點)</h2>
        <div class="row">
          <label class="label">選擇身分</label>
          <select id="role" class="select">
            <option value="user">一般使用者</option>
            <option value="admin">管理員</option>
          </select>
        </div>
        <div class="row" style="margin-top:10px">
          <label class="label">密碼</label>
          <input id="pwd" type="password" class="input" placeholder="點一下點儲存的密碼"/>
        </div>
        <div class="row" style="margin-top:14px">
          <button id="btnLogin" class="btn btn-accent">登入</button>
          <button id="btnLogout" class="btn">登出</button>
        </div>
        <hr/>
        <div class="notice">
         有問題找我別搞</span>
        </div>
      </div>

      <div class="panel">
        <h2>要前往哪個網頁？</h2>
        <div class="grid">
          <div class="tile" id="gotoYifu">
            <h3>益福汽車管理系統</h3>
            <p>進去不要點登出裡面密碼都不一樣(點進去轉圈圈就是我沒開伺服器直接跟我說)。</p>
          </div>
          <div class="tile" id="gotoSalary">
            <h3>薪資計算</h3>
            <p>你們進不去別點 點了有驚喜。</p>
          </div>
        </div>
        <div style="margin-top:12px" class="notice">
        有問體找我!!!
        </div>
      </div>
    </div>
    <div class="footer">
    有問題找我我在睡覺找老闆
    </div>
  </div>
  <script src="auth.js"></script>
  <!-- Admin Panel (YiFu only) -->
  <div class="card" id="adminPanel" style="display:none; margin-top:16px">
    <div class="header">
      <div class="h1">管理員面板（僅益福 :3000）</div>
      <div class="badge">Online Monitor</div>
    </div>
    <div class="body" style="grid-template-columns:1fr">
      <div class="row">
        <button id="btnRefreshSessions" class="btn btn-green">更新線上名單</button>
      </div>
      <div class="row" style="overflow:auto; max-height:320px">
        <table id="sessTable" class="table" style="width:100%">
          <thead>
            <tr>
              <th>userId</th><th>role</th><th>sid</th><th>lastSeen(s)</th><th>操作</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="row" style="gap:8px">
        <input id="forceUserId" class="input" placeholder="userId（可選）"/>
        <input id="forceSid" class="input" placeholder="sid（可選）"/>
        <button id="btnForceLogout" class="btn">強制登出（益福）</button>
      </div>
      <p class="muted" style="margin-top:8px">提示：目前僅改益福系統。如需同時讓「薪資」也登出，可選擇下方「最佳努力登出兩邊」。</p>
      <div class="row" style="gap:8px">
        <button id="btnBestEffortBoth" class="btn">最佳努力登出兩邊</button>
      </div>
    </div>
  </div>

  <script>
    const YIFU_TARGET = 'http://yifucar.ddns.net:3000';
    const SALARY_TARGET = 'http://yifucar.ddns.net:3001';
    // ---- Admin panel (YiFu only) ----
    const adminPanel = document.getElementById('adminPanel');
    const btnRefreshSessions = document.getElementById('btnRefreshSessions');
    const sessTableBody = document.querySelector('#sessTable tbody');
    const forceUserId = document.getElementById('forceUserId');
    const forceSid = document.getElementById('forceSid');
    const btnForceLogout = document.getElementById('btnForceLogout');
    const btnBestEffortBoth = document.getElementById('btnBestEffortBoth');

    function showAdminIfNeeded() {
      Auth.getCurrent().then(cur => {
        if (cur.ok && cur.role === 'admin') {
          adminPanel.style.display = '';
        } else {
          adminPanel.style.display = 'none';
        }
      });
    }

    async function yifuSessions(){
      try{
        const r = await fetch(`${YIFU_TARGET}/api/admin/sessions`, { credentials:'include' });
        if(!r.ok) throw new Error('fail to fetch sessions');
        return await r.json();
      }catch(e){ return []; }
    }
    function renderSessions(rows){
      sessTableBody.innerHTML = '';
      const now = Date.now();
      rows.forEach(r=>{
        const tr = document.createElement('tr');
        const td = (t)=>{ const x = document.createElement('td'); x.textContent = t; return x; };
        tr.appendChild(td(r.userId || ''));
        tr.appendChild(td(r.role || ''));
        tr.appendChild(td(r.sid || ''));
        const last = r.lastSeen ? Math.floor((now - r.lastSeen)/1000) : '';
        tr.appendChild(td(last));
        const op = document.createElement('td');
        const b = document.createElement('button');
        b.className = 'btn';
        b.textContent = '登出此 SID';
        b.onclick = ()=> adminForceLogout({ sid: r.sid });
        op.appendChild(b);
        tr.appendChild(op);
        sessTableBody.appendChild(tr);
      });
    }
    async function adminRefresh(){
      const list = await yifuSessions();
      renderSessions(list);
    }
    async function adminForceLogout({ userId=null, sid=null }={}){
      const body = userId ? { userId } : { sid };
      const r = await fetch(`${YIFU_TARGET}/api/admin/logout`, {
        method:'POST', headers:{'Content-Type':'application/json'},
        credentials:'include', body: JSON.stringify(body)
      });
      if(!r.ok){ alert('登出指令失敗'); return; }
      alert('已送出（益福）');
      adminRefresh();
    }

    // Best-effort both: 只改益福伺服器的情況下，盡量讓薪資也登出（需要兩邊共用 cookie 名稱 `sid`）
    async function bestEffortLogoutBoth({ userId=null, sid=null }={}){
      // 1) 對 3000 下 admin logout（無論 userId 或 sid）
      await adminForceLogout({ userId, sid });
      // 2) 讓瀏覽器觸發薪資端感知登出（若兩邊共用 domain cookie 名稱 `sid`，此步可生效）
      try{
        const iframe = document.createElement('iframe');
        iframe.style.display='none';
        iframe.src = `${SALARY_TARGET}/healthz`; // 促使該域發請求，拿到「無 session」狀態
        document.body.appendChild(iframe);
        setTimeout(()=> iframe.remove(), 3000);
      }catch(e){}
      alert('已嘗試對「兩邊」登出（最佳努力）');
    }

    btnRefreshSessions?.addEventListener('click', adminRefresh);
    btnForceLogout?.addEventListener('click', ()=>{
      const u = forceUserId.value.trim();
      const s = forceSid.value.trim();
      if(!u && !s){ alert('請填 userId 或 sid'); return; }
      adminForceLogout({ userId: u || null, sid: s || null });
    });
    btnBestEffortBoth?.addEventListener('click', ()=>{
      const u = forceUserId.value.trim();
      const s = forceSid.value.trim();
      if(!u && !s){ alert('請填 userId 或 sid'); return; }
      bestEffortLogoutBoth({ userId: u || null, sid: s || null });
    });

    showAdminIfNeeded();

    const statusBadge = document.getElementById('statusBadge');
    const roleSel = document.getElementById('role');
    const pwd = document.getElementById('pwd');
    const btnLogin = document.getElementById('btnLogin');
    const btnLogout = document.getElementById('btnLogout');
    const gotoYifu = document.getElementById('gotoYifu');

    async function refreshStatus(){
      const cur = await Auth.getCurrent();
      if(cur.ok){
        statusBadge.textContent = `已登入：${cur.role==='admin'?'管理員':'一般使用者'}`;
        statusBadge.className = 'badge';
      }else{
        statusBadge.textContent = '未登入';
        statusBadge.className = 'badge';
      }
    }
    btnLogin.addEventListener('click', async ()=>{
      const role = roleSel.value;
      const res = await Auth.loginWithPassword(role, pwd.value);
      if(!res.ok){
        alert(res.message || '登入失敗');
        return;
      }
      pwd.value = '';
      await refreshStatus();
      alert('登入成功！');
    });
    btnLogout.addEventListener('click', ()=>{
      Auth.logout();
      refreshStatus();
      alert('已登出');
    });
    gotoYifu.addEventListener('click', async ()=>{
      const ok = await Auth.requireSignedInOrRedirect();
      if(!ok) return;
      const cur = await Auth.getCurrent();
      const url = `${YIFU_TARGET}/sso/consume?jwt=${encodeURIComponent(cur.token)}&redirect=/`;
      window.open(url, '_blank', 'noopener,noreferrer');
    });

    refreshStatus();
  </script>

    <script>
    (function(){
      const gotoSalary = document.getElementById('gotoSalary');
      if(!gotoSalary) return;
      gotoSalary.addEventListener('click', async ()=>{
        const cur2 = await (window.Auth && Auth.getCurrent ? Auth.getCurrent() : Promise.resolve({ok:false}));
        if(!cur2.ok || cur2.role!=='admin'){
          window.open('https://www.gxgif.com/pic/kb/202328205818.gif', '_blank', 'noopener,noreferrer');
          return;
        }
        const url2 = `${SALARY_TARGET}/sso/consume?jwt=${encodeURIComponent(cur2.token)}&redirect=/`;
        window.open(url2, '_blank', 'noopener,noreferrer');
      });
    })();
    </script>
    
</body>
</html>