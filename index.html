
<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>入口｜角色登入與系統導覽</title>
  <link rel="stylesheet" href="style.css"/>
</head>
<body>
  <div class="card">
    <div class="header">
      <div class="h1">益福入口 Portal</div>
      <div id="statusBadge" class="badge">未登入</div>
    </div>
    <div class="body">
      <div class="panel">
        <h2>登入(密碼幫你們紀錄完了直接點)</h2>
        <div class="row">
          <label class="label">選擇身分</label>
          <select id="role" class="select">
            <option value="user">一般使用者</option>
            <option value="admin">管理員</option>
          </select>
        </div>
        <div class="row" style="margin-top:10px">
          <label class="label">密碼</label>
          <input id="pwd" type="password" class="input" placeholder="點一下點儲存的密碼"/>
        </div>
        <div class="row" style="margin-top:14px">
          <button id="btnLogin" class="btn btn-accent">登入</button>
          <button id="btnLogout" class="btn">登出</button>
        </div>
        <hr/>
        <div class="notice">
         有問題找我別搞</span>
        </div>
      </div>

      <div class="panel">
        <h2>要前往哪個網頁？</h2>
        <div class="grid">
          <div class="tile" id="gotoYifu">
            <h3>益福汽車管理系統</h3>
            <p>進去不要點登出裡面密碼都不一樣(點進去轉圈圈就是我沒開伺服器直接跟我說)。</p>
          </div>
          <div class="tile" id="gotoSalary">
            <h3>薪資計算</h3>
            <p>你們進不去別點 點了有驚喜。</p>
          </div>
        </div>
        <div style="margin-top:12px" class="notice">
        有問體找我!!!
        </div>
      </div>
    </div>
    <div class="footer">
    有問題找我我在睡覺找老闆
    </div>
  </div>
  <script src="auth.js"></script>
  <script>
    const YIFU_TARGET = 'http://yifucar.ddns.net:3000';
    const SALARY_TARGET = 'http://yifucar.ddns.net:3001';
    const statusBadge = document.getElementById('statusBadge');
    const roleSel = document.getElementById('role');
    const pwd = document.getElementById('pwd');
    const btnLogin = document.getElementById('btnLogin');
    const btnLogout = document.getElementById('btnLogout');
    const gotoYifu = document.getElementById('gotoYifu');
    const gotoSalary = document.getElementById('gotoSalary');

    async function refreshStatus(){
      const cur = await Auth.getCurrent();
      if(cur.ok){
        statusBadge.textContent = `已登入：${cur.role==='admin'?'管理員':'一般使用者'}`;
        statusBadge.className = 'badge';
      }else{
        statusBadge.textContent = '未登入';
        statusBadge.className = 'badge';
      }
    }
    btnLogin.addEventListener('click', async ()=>{
      const role = roleSel.value;
      const res = await Auth.loginWithPassword(role, pwd.value);
      if(!res.ok){
        alert(res.message || '登入失敗');
        return;
      }
      pwd.value = '';
      await refreshStatus();
      alert('登入成功！');
    });
    btnLogout.addEventListener('click', ()=>{
      Auth.logout();
      refreshStatus();
      alert('已登出');
    });
    gotoYifu.addEventListener('click', async ()=>{
      const ok = await Auth.requireSignedInOrRedirect();
      if(!ok) return;
      const cur = await Auth.getCurrent();
      const url = `${YIFU_TARGET}/sso/consume?jwt=${encodeURIComponent(cur.token)}&redirect=/`;
      location.href = url;
    });
    gotoSalary.addEventListener('click', async ()=>{
      const cur = await Auth.getCurrent();
      if(!cur.ok || cur.role!=='admin'){
        alert('薪資頁面僅供管理員！請以管理員身分登入。');
        return;
      }
      const cur2 = await Auth.getCurrent();
      const url2 = `${SALARY_TARGET}/sso/consume?jwt=${encodeURIComponent(cur2.token)}&redirect=/`;
      location.href = url2;
    });

    refreshStatus();
  </script>

    <script>
    (function(){
      const gotoSalary = document.getElementById('gotoSalary');
      if(!gotoSalary) return;
      gotoSalary.addEventListener('click', async ()=>{
        const cur2 = await (window.Auth && Auth.getCurrent ? Auth.getCurrent() : Promise.resolve({ok:false}));
        if(!cur2.ok || cur2.role!=='admin'){
          location.href = 'https://www.gxgif.com/pic/kb/202328205818.gif';
          return;
        }
        const url2 = `${SALARY_TARGET}/sso/consume?jwt=${encodeURIComponent(cur2.token)}&redirect=/`;
        location.href = url2;
      });
    })();
    </script>
    
</body>
</html>
